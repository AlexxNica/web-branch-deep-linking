/*! Branch Metrics Web SDK - branch-web-sdk: v0.1.0 - 2014-10-14 17:06:06 PDT */
var branch_map={debugMessages:{nonInit:"Branch SDK not initialized",existingInit:"Branch SDK already initilized",missingParam:"Missing required parameter ",invalidParam:"Invalid parameter ",missingAppId:"Missing Branch app ID"},formap:{string:/.*/,email:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,password:/.{6,}/,uuid:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,appId:/^[0-9]{17}$/,identityId:/^[0-9]{17}$/,sessionId:/^[0-9]{17}$/,jsonObj:"object",number:/^d+$/},resources:{session:{sessionOpen:{endpoint:"/v1/open",method:"POST",params:{app_id:{type:"appId",required:!0},identity_id:{type:"identityId",required:!1},link_identifier:{type:"string",required:!1},is_referrable:{type:"number",required:!0}}},sessionProfile:{endpoint:"/v1/profile",method:"POST",ref:"obj",params:{app_id:{type:"appId",required:!0},identity_id:{type:"identityId",required:!1},obj:{type:"jsonObj",required:!0,ref:"obj",params:{identity:{type:"string",required:!0},set:{type:"jsonObj",required:!1},add:{type:"jsonObj",required:!1},append:{type:"jsonObj",required:!1},union:{type:"jsonObj",required:!1}}}}},sessionClose:{endpoint:"/v1/close",method:"POST",params:{app_id:{type:"appId",required:!0},session_id:{type:"sessionId",required:!0}}},sessionLogout:{endpoint:"/v1/logout",method:"POST",params:{app_id:{type:"appId",required:!0},session_id:{type:"sessionId",required:!0}}}},referrals:{showReferrals:{endpoint:"/v1/referrals/:identity_id",method:"GET",rest:["identity_id"],params:{app_id:{type:"appId",required:!0},identity_id:{type:"identityId",required:!0}}},showCredits:{endpoint:"/v1/credits/:identity_id",method:"GET",rest:["identity_id"],params:{app_id:{type:"appId",required:!0},identity_id:{type:"identityId",required:!0}}},redeemCredits:{endpoint:"/v1/redeem",method:"POST",ref:"obj",params:{app_id:{type:"appId",required:!0},identity_id:{type:"identityId",required:!0},obj:{type:"jsonObj",required:!0,ref:"obj",params:{amount:{type:"number",required:!0},bucket:{type:"string",required:!1}}}}}},links:{createLink:{endpoint:"/v1/url",method:"POST",ref:"obj",params:{app_id:{type:"appId",required:!0},identity:{type:"identityId",required:!0},obj:{type:"jsonObj",required:!0,ref:"obj",params:{data:{type:"jsonObj",required:!1},tags:{type:"jsonArray",required:!1},feature:{type:"string",required:!1},channel:{type:"string",required:!1},stage:{type:"string",required:!1},type:{type:"number",required:!1}}}}}},events:{track:{endpoint:"/v1/event",method:"POST",params:{app_id:{type:"appId",required:!0},session_id:{type:"sessionId",required:!0},event:{type:"string",required:!0},metadata:{type:"jsonObj",required:!1}}}}}},Branch=function(a,b){"use strict";this.initialized=!1,this.api={},this.utils={},this.utils.console=function(a){return b&&console.error(a),!1},this.utils.readSession=function(){return JSON.parse(sessionStorage.getItem("branch_session"))},this.utils.identity=function(){var a="";return sessionStorage.getItem("branch_session")&&(a=this.readSession().identity_id),a},this.utils.session=function(){var a="";return sessionStorage.getItem("branch_session")&&(a=this.readSession().session_id),a},this.utils.mergeMeta=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},this.utils.hashValue=function(a){var b;try{b=location.hash.match(new RegExp(a+":([^&]*)"))[1]}catch(c){b=void 0}return b},this.utils.queue=function(){var a=this;a.free=!0,a.chain=[],a.next=function(){a.chain.length>0?(a.free=!0,a.chain[0].call(),a.chain.shift()):a.free=!0},a.route=function(b,c){a.free?(b(),a.free=!1):c()}},this.api.validateRequest=function(a,b){for(var e in a.params){var f=a.params[e];if(f.required===!0&&("undefined"==typeof b[e]||""===b[e]||null===b[e]))return c.utils.console(d.debugMsgs.missingParam+e),!1;if("jsonObj"==f.type){if(f.required===!0&&"object"!=typeof b[e])return c.utils.console(d.debugMsgs.invalidParam+e),!1;if(f.params)return c.api.validateRequest(a.params[f.ref],b[f.ref])}else if(f.type="jsonArray"){if(f.required===!0&&!b[e]instanceof Array)return c.utils.console(d.debugMsgs.invalidParam+e),!1}else if(!d.formap[f.type].test(b[e]))return c.utils.console(d.debugMsgs.invalidParam+e),!1}return!0},this.api.makeRequest=function(a,b,e,f){if(c.api.validateRequest(a,b)){"function"!=typeof e&&(e=function(a){c.utils.console("Request complete",a)}),"function"!=typeof f&&(f=function(a,b,d){c.utils.console("Request failed",[a,b,d])});var g;g=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),g.onreadystatechange=function(){4===g.readyState&&200===g.status?e(JSON.parse(g.responseText)):4===g.readyState&&402===g.status&&e({error:"Not enough credits to redeem."})};var h="";if(a.rest)for(var i=0;i<a.rest.length;i++)a.endpoint=a.endpoint.replace(":"+a.rest[i],b[a.rest[i]]),delete b[a.rest[i]];if("GET"===a.method){h="?";for(var j in b)h+=j+"="+b[j]+"&"}g.open(a.method,d.connector.url+a.endpoint+h.substring(0,h.length-1),!0),g.setRequestHeader("Content-Type","application/json"),g.setRequestHeader("Branch-Connector",d.connector.name+"/"+d.connector.version),a.ref&&(b=c.utils.mergeMeta(b,b[a.ref]),delete b[a.ref]),g.send(JSON.stringify(b))}},this.init=function(a){if(null===c.utils.readSession()||void 0!==d.linkId){var b=function(a){c.api.makeRequest(d.resources.session.sessionOpen,{app_id:d.appId,identity_id:c.utils.identity(),link_identifier:void 0!==d.linkId?d.linkId:"",is_referrable:1},function(b){sessionStorage.setItem("branch_session",JSON.stringify(b)),c.initialized=!0,"function"==typeof a&&a(b)})};c.q.route(function(){b(function(b){c.q.next(),"function"==typeof a&&a(b)})},function(){c.q.chain.push(function(){c.initialized.apply(null,[a])})})}else c.initialized=!0,"function"==typeof a&&a(c.utils.readSession())},this.close=function(a){if(!c.initialized)return c.utils.console(d.debugMsgs.nonInit);var b=function(a){c.api.makeRequest(d.resources.session.sessionClose,{app_id:d.appId,session_id:c.utils.session()},function(b){sessionStorage.clear(),c.initialized=!1,"function"==typeof a&&a(b)})};c.q.route(function(){b(function(b){c.q.next(),"function"==typeof a&&a(b)})},function(){c.q.chain.push(function(){c.close.apply(null,[a])})})},this.logout=function(a){if(!c.initialized)return c.utils.console(d.debugMsgs.nonInit);var b=function(a){c.api.makeRequest(d.resources.session.sessionLogout,{app_id:d.appId,session_id:c.utils.session()},function(b){var d=c.utils.readSession();d.session_id=b.session_id,d.identity_id=b.identity_id,d.link=b.link,sessionStorage.setItem("branch_session",JSON.stringify(d)),"function"==typeof a&&a(b)})};c.q.route(function(){b(function(b){c.q.next(),"function"==typeof a&&a(b)})},function(){c.q.chain.push(function(){c.logout.apply(null,[a])})})},this.track=function(a,b,e){if(!c.initialized)return c.utils.console(d.debugMsgs.nonInit);"function"==typeof b&&(e=b,b={});var f={url:document.URL,user_agent:navigator.userAgent,language:navigator.language};b&&(f=c.utils.mergeMeta(f,b));var g=function(b){c.api.makeRequest(d.resources.events.track,{app_id:d.appId,session_id:c.utils.session(),event:a,metadata:f},function(a){"function"==typeof b&&b(a)})};c.q.route(function(){g(function(a){c.q.next(),e&&e(a)})},function(){c.q.chain.push(function(){c.track.apply(null,[a,b,e])})})},this.identify=function(a,b){if(!c.initialized)return c.utils.console(d.debugMsgs.nonInit);var e=function(b){c.api.makeRequest(d.resources.session.sessionProfile,{app_id:d.appId,identity_id:c.utils.identity(),obj:a},function(a){var d=c.utils.readSession();d.identity_id=a.identity_id,d.link=a.link,d.referring_data=a.referring_data,d.referring_identity=a.referring_identity,sessionStorage.setItem("branch_session",JSON.stringify(d)),"function"==typeof b&&b(a)})};c.q.route(function(){e(function(a){c.q.next(),b&&b(a)})},function(){c.q.chain.push(function(){c.identify.apply(null,[a,b])})})},this.createLink=function(a,b){return c.initialized?void c.api.makeRequest(d.resources.links.createLink,{app_id:d.appId,identity:c.utils.identity(),obj:a},function(a){"function"==typeof b&&b(a.url)}):c.utils.console(d.debugMsgs.nonInit)},this.showReferrals=function(a){return c.initialized?void c.api.makeRequest(d.resources.referrals.showReferrals,{app_id:d.appId,identity_id:c.utils.identity()},function(b){"function"==typeof a&&a(b)}):c.utils.console(d.debugMsgs.nonInit)},this.showCredits=function(a){return c.initialized?void c.api.makeRequest(d.resources.referrals.showCredits,{app_id:d.appId,identity_id:c.utils.identity()},function(b){"function"==typeof a&&a(b)}):c.utils.console(d.debugMsgs.nonInit)},this.redeemCredits=function(a,b){return c.initialized?void c.api.makeRequest(d.resources.referrals.redeemCredits,{app_id:d.appId,identity_id:c.utils.identity(),obj:a},function(a){"function"==typeof b&&b(a)}):c.utils.console(d.debugMsgs.nonInit)},b="undefined"!=typeof b?b:!1;var c=this,d={appId:a,connector:{url:"http://api.branchmetrics.io",name:"web-sdk",version:"0.1"},linkId:c.utils.hashValue("r"),formap:branch_map.formap,resources:branch_map.resources,debugMsgs:branch_map.debugMessages};return void 0===a?(c.utils.console(d.debugMsgs.missingAppId),!1):void(c.q=new c.utils.queue)},q=window.branch.queued;window.branch=new Branch(window.branch.app_id,window.branch.debug,window.branch.callback),branch.init(function(){if(q.length)for(i=0;i<q.length;i++)window.branch[q[i].shift()].apply(window.branch,q[i]);"function"==typeof self.init_callback&&self.init_callback()});